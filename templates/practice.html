<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复习闪卡</title>
    <!-- 使用最新版本的marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- 先加载MathJax配置 -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                displayMath: [['$$','$$'], ['\\[','\\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            CommonHTML: { 
                linebreaks: { automatic: true },
                scale: 100,
                minScaleAdjust: 100
            },
            "HTML-CSS": { 
                linebreaks: { automatic: true },
                scale: 100,
                minScaleAdjust: 100
            },
            SVG: { 
                linebreaks: { automatic: true },
                scale: 100,
                minScaleAdjust: 100
            },
            showMathMenu: false,
            showProcessingMessages: false,
            messageStyle: "none"
        });
    </script>
    <!-- 然后加载MathJax库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <!-- 加载highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <style>
        /* 基础样式 */
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        .card-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 300px;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 1px solid #ddd;
        }
        .card-content {
            margin-bottom: 20px;
        }
        .answer {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .controls {
            display: none;
            text-align: center;
            padding: 20px 0;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .show-answer {
            background-color: #007bff;
            color: white;
        }
        .show-answer:hover {
            background-color: #0056b3;
        }
        .again {
            background-color: #dc3545;
            color: white;
        }
        .hard {
            background-color: #ffc107;
            color: black;
        }
        .good {
            background-color: #28a745;
            color: white;
        }
        .easy {
            background-color: #17a2b8;
            color: white;
        }
        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #eee;
            margin-bottom: 20px;
        }
        .progress {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .metadata {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .importance-probability {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        /* 添加数学公式样式 */
        .MathJax_Display {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 1em 0 !important;
            padding: 0.5em 0;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .MathJax {
            outline: 0;
        }
        .markdown {
            overflow-x: auto;
            max-width: 100%;
            white-space: pre-wrap;  /* 保留换行符 */
            word-wrap: break-word;  /* 允许长单词换行 */
            line-height: 1.6;       /* 增加行高 */
        }
        
        /* 确保列表和段落有合适的间距 */
        .markdown p {
            margin: 1em 0;
        }
        .markdown ul, .markdown ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        .error-message {
            color: #dc3545;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #dc3545;
            border-radius: 4px;
            display: none;
        }
        
        .qa-section {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #eee;
            display: none;
        }
        
        .qa-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .qa-answer {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            min-height: 100px;
            border: 1px solid #ddd;
        }
        .qa-answer[contenteditable="true"] {
            outline: none;
            cursor: text;
        }
        .qa-answer pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
        }
        .qa-answer code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 85%;
        }
        .qa-answer pre code {
            padding: 0;
            background-color: transparent;
            border-radius: 0;
        }
        .edit-buttons {
            margin-top: 10px;
            text-align: right;
            display: none;
        }
        .edit-buttons button {
            margin-left: 10px;
        }
        .qa-actions {
            display: none;
            margin-top: 10px;
            text-align: right;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-ask {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-append {
            background-color: #28a745;
            color: white;
        }
        
        .btn-new {
            background-color: #007bff;
            color: white;
        }
        /* 强调样式 */
        .markdown strong {
            color: #2c3e50;
            font-weight: 600;
        }
        /* 段落间距 */
        .markdown > *:not(:last-child) {
            margin-bottom: 1em;
        }
        .difficulty-btn {
            display: none;
        }
        .progress {
            margin: 20px;
            text-align: center;
        }
        .loading-spinner {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e1e4e8;
        }
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner span {
            display: inline-block;
            vertical-align: middle;
            color: #666;
            font-size: 14px;
        }
        /* 代码块样式优化 */
        pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid #e1e4e8;
            position: relative;
        }
        
        pre code.hljs {
            background: none;
            padding: 0;
            margin: 0;
            border: none;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            word-break: normal;
            word-wrap: normal;
            tab-size: 4;
        }
        
        /* 行内代码样式 */
        code:not(pre code) {
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            padding: 0.2em 0.4em;
            font-size: 85%;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        /* 数学公式容器样式 */
        .math-container {
            overflow-x: auto;
            margin: 1em 0;
            padding: 0.5em 0;
        }
        
        /* 确保数学公式正确对齐 */
        .MathJax_Display {
            margin: 0.5em 0 !important;
        }
        
        /* 优化qa-answer的样式 */
        .qa-answer {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            word-wrap: break-word;
            padding: 16px;
            background-color: #ffffff;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .qa-answer[contenteditable="true"] {
            outline: 2px solid #0366d6;
        }
        
        /* 添加编辑状态的视觉反馈 */
        .qa-answer:focus {
            outline: 2px solid #0366d6;
            box-shadow: 0 0 0 3px rgba(3,102,214,0.3);
        }

        /* 代码相关样式 */
        .inline-code {
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            padding: 0.2em 0.4em;
            font-size: 85%;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            color: #24292e;
            margin: 0 0.2em;
        }

        /* 代码高亮样式 */
        .hljs-comment,
        .hljs-quote {
            color: #6a737d;
            font-style: italic;
        }

        .hljs-keyword,
        .hljs-selector-tag,
        .hljs-title,
        .hljs-section,
        .hljs-doctag,
        .hljs-name,
        .hljs-strong {
            color: #d73a49;
            font-weight: bold;
        }

        .hljs-string {
            color: #032f62;
        }

        .hljs-number {
            color: #005cc5;
        }

        .hljs-variable,
        .hljs-template-variable,
        .hljs-tag,
        .hljs-name,
        .hljs-selector-id,
        .hljs-selector-class,
        .hljs-regexp,
        .hljs-deletion {
            color: #22863a;
        }
        
        /* 代码块样式 */
        pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid #e1e4e8;
            position: relative;
        }
        
        pre code.hljs {
            background: none;
            padding: 0;
            margin: 0;
            border: none;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            word-break: normal;
            word-wrap: normal;
            tab-size: 4;
        }
        
        /* 数学公式样式 */
        .math-block {
            overflow-x: auto;
            margin: 1em 0;
            padding: 0.5em;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        
        .math-inline {
            padding: 0 0.2em;
            background-color: #f8f9fa;
            border-radius: 2px;
        }
        
        /* 确保公式正确对齐 */
        .MathJax_Display {
            margin: 0.5em 0 !important;
        }
        
        .MathJax {
            outline: 0;
        }
        
        .generation-progress {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e1e4e8;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .progress-detail {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
    <script>
        (function(window, document) {
            'use strict';
            
            // Initialize global variables
            window.flashcards = {{ flashcards|tojson|safe }};
            window.filename = "{{ filename }}";
            window.currentCardIndex = 0;
            window.showingAnswer = false;
            
            // Configure marked when the window loads
            window.onload = function() {
                if (typeof marked === 'undefined') {
                    console.error('Marked library not loaded!');
                    return;
                }

                var renderer = new marked.Renderer();
                
                renderer.codespan = function(code) {
                    return '<code class="inline-code">' + code + '</code>';
                };
                
                renderer.code = function(code, language) {
                    code = code.trim()
                        .replace(/^\s+/gm, '')
                        .replace(/\n{3,}/g, '\n\n');
                    
                    var validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                    
                    try {
                        var highlighted = hljs.highlight(code, {
                            language: validLanguage,
                            ignoreIllegals: true
                        }).value;
                        
                        return '<pre><code class="hljs language-' + validLanguage + '">' + highlighted + '</code></pre>';
                    } catch (error) {
                        console.error('Error highlighting code:', error);
                        return '<pre><code class="hljs">' + code + '</code></pre>';
                    }
                };

                marked.setOptions({
                    renderer: renderer,
                    gfm: true,
                    breaks: true,
                    pedantic: false,
                    sanitize: false,
                    smartLists: true,
                    smartypants: true,
                    xhtml: false
                });
                
                // Initialize highlight.js
                hljs.configure({
                    tabReplace: '    ',
                    languages: ['python', 'javascript', 'bash', 'cpp', 'java', 'json', 'markdown'],
                    cssSelector: 'pre code'
                });
                
                // Initialize syntax highlighting
                document.querySelectorAll('pre code').forEach(function(block) {
                    hljs.highlightBlock(block);
                });
            };

            // Markdown rendering function
            window.renderMarkdown = function(text) {
                if (typeof marked === 'undefined') {
                    console.error('Marked library not loaded!');
                    return text;
                }
                
                try {
                    // 预处理文本，处理特殊情况
                    var processedText = text
                        // 处理代码块，确保正确的缩进和换行
                        .replace(/```(\w+)?\s*([\s\S]*?)```/g, function(match, lang, code) {
                            // 清理代码文本
                            code = code
                                .replace(/^\s+|\s+$/g, '')  // 移除开头和结尾的空白
                                .replace(/\\n/g, '\n')      // 处理转义的换行符
                                .replace(/\n\s*\n/g, '\n')  // 移除多余的空行
                                .split('\n')                // 分割成行
                                .map(function(line) {
                                    return line.trim();     // 清理每行的空白
                                })
                                .join('\n');               // 重新组合

                            // 返回处理后的代码块
                            return '\n```' + (lang || '') + '\n' + code + '\n```\n';
                        })
                        // 处理行内代码
                        .replace(/`([^`]+)`/g, function(match, code) {
                            return '`' + code.trim() + '`';
                        })
                        // 处理数学公式
                        .replace(/\$\$(.*?)\$\$/g, function(match, formula) {
                            return '\n$$' + formula.trim() + '$$\n';
                        })
                        .replace(/\$(.*?)\$/g, function(match, formula) {
                            return '$' + formula.trim() + '$';
                        })
                        .trim();

                    // 配置 marked 选项
                    marked.setOptions({
                        gfm: true,
                        breaks: true,
                        pedantic: false,
                        sanitize: false,
                        smartLists: true,
                        smartypants: true,
                        xhtml: false,
                        highlight: function(code, lang) {
                            if (lang && hljs.getLanguage(lang)) {
                                try {
                                    return hljs.highlight(code, {
                                        language: lang,
                                        ignoreIllegals: true
                                    }).value;
                                } catch (err) {
                                    console.error('Error highlighting code:', err);
                                }
                            }
                            return hljs.highlightAuto(code).value;
                        }
                    });

                    // 渲染 Markdown
                    var renderedHtml = marked.parse(processedText);
                    
                    // 后处理：修复可能的格式问题
                    renderedHtml = renderedHtml
                        // 确保代码块有正确的类名
                        .replace(/<pre><code class="language-(\w+)">/g, '<pre><code class="hljs language-$1">')
                        // 确保数学公式周围有足够的空间
                        .replace(/(<p>)?\s*(\$\$[\s\S]*?\$\$)\s*(<\/p>)?/g, '<div class="math-block">$2</div>')
                        .replace(/(<p>)?\s*(\$[\s\S]*?\$)\s*(<\/p>)?/g, '<span class="math-inline">$2</span>');

                    return renderedHtml;
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    return text;
                }
            };
            
            // Update progress function
            window.updateProgress = function() {
                var cards = document.querySelectorAll('.card');
                var total = cards.length;
                var current = window.currentCardIndex + 1;
                
                document.getElementById('currentCard').textContent = Math.min(current, total);
                document.getElementById('totalCards').textContent = total;
                
                var progressBar = document.querySelector('.progress-bar .progress');
                if (progressBar) {
                    var percentage = Math.min((current / total) * 100, 100);
                    progressBar.style.width = percentage + '%';
                }
            };
            
            // Show answer function
            window.showAnswer = function(btn) {
                if (!btn) return;
                
                var card = btn.closest('.card');
                if (!card) return;
                
                var answerElement = card.querySelector('.answer');
                var difficultyBtns = card.querySelectorAll('.difficulty-btn');
                var qaSection = card.querySelector('.qa-section');
                
                if (answerElement) {
                    answerElement.style.display = 'block';
                    MathJax.Hub.Queue(['Typeset', MathJax.Hub, answerElement]);
                }
                
                if (difficultyBtns) {
                    difficultyBtns.forEach(function(btn) {
                        btn.style.display = 'inline-block';
                    });
                }

                if (qaSection) {
                    qaSection.style.display = 'block';
                }
                
                btn.style.display = 'none';
            };
            
            // Record difficulty function
            window.recordDifficulty = function(difficulty, btn) {
                var card = btn.closest('.card');
                var cardId = card.dataset.id;
                var cardIndex = parseInt(card.dataset.index);
                
                var interval = 0;
                var easeFactor = parseFloat(card.dataset.easeFactor || 2.5);
                
                switch(difficulty) {
                    case 'hard':
                        interval = 1;
                        easeFactor = Math.max(1.3, easeFactor - 0.2);
                        break;
                    case 'medium':
                        interval = 3;
                        break;
                    case 'easy':
                        interval = 7;
                        easeFactor = easeFactor + 0.1;
                        break;
                }

                var now = new Date();
                var nextReview = new Date(now);
                nextReview.setDate(nextReview.getDate() + interval);
                
                fetch('/api/update_card_state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        card_id: cardId,
                        review_data: {
                            next_review: nextReview.toISOString().slice(0, 19).replace('T', ' '),
                            difficulty: difficulty,
                            ease_factor: easeFactor,
                            interval: interval
                        }
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to update card state');
                    }
                    return response.json();
                })
                .then(function() {
                    window.currentCardIndex++;
                    window.updateProgress();
                    
                    var currentCard = document.querySelector('.card[data-index="' + cardIndex + '"]');
                    var nextCard = document.querySelector('.card[data-index="' + (cardIndex + 1) + '"]');
                    
                    if (currentCard) {
                        currentCard.style.display = 'none';
                    }
                    
                    if (nextCard) {
                        nextCard.style.display = 'block';
                        MathJax.Hub.Queue(['Typeset', MathJax.Hub, nextCard]);
                    } else {
                        alert('恭喜！你已完成所有闪卡复习。');
                        window.location.href = '/';
                    }
                })
                .catch(function(error) {
                    console.error('Error updating card state:', error);
                    window.showError('更新卡片状态失败: ' + error.message);
                });
            };
            
            // Error handling function
            window.showError = function(message) {
                var errorElement = document.querySelector('.error-message');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                console.error('Error:', message);
            };
            
            // Ask DeepSeek function
            window.askDeepSeek = function(btn) {
                var card = btn.closest('.card');
                var question = card.querySelector('.qa-input').value.trim();
                if (!question) {
                    window.showError('请输入问题');
                    return;
                }

                var context = {
                    question: card.querySelector('.question').innerHTML,
                    answer: card.querySelector('.answer').innerHTML
                };

                var loadingSpinner = card.querySelector('.loading-spinner');
                var qaAnswer = card.querySelector('.qa-answer');
                var qaActions = card.querySelector('.qa-actions');
                var editButtons = card.querySelector('.edit-buttons');
                var startTime = Date.now();
                var timerElement = loadingSpinner.querySelector('span');
                var timerInterval;
                
                // Show loading spinner and start timer
                loadingSpinner.style.display = 'block';
                qaAnswer.style.display = 'none';
                qaActions.style.display = 'none';
                editButtons.style.display = 'none';
                
                // Update timer every second
                timerInterval = setInterval(function() {
                    var elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    timerElement.textContent = '思考中... (' + elapsedSeconds + ' 秒)';
                }, 1000);

                fetch('/api/ask_deepseek', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        context: '问题：' + context.question + '\n\n答案：' + context.answer
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('请求失败');
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Clear timer
                    clearInterval(timerInterval);
                    
                    if (!data.success) {
                        throw new Error(data.error || '获取答案失败');
                    }

                    // Hide loading spinner
                    loadingSpinner.style.display = 'none';
                    
                    // Render answer content
                    qaAnswer.innerHTML = window.renderMarkdown(data.answer);
                    
                    // Highlight code blocks
                    qaAnswer.querySelectorAll('pre code').forEach(function(block) {
                        var language = block.className.replace('language-', '');
                        
                        var code = block.textContent
                            .replace(/\\n/g, '\n')
                            .replace(/\\\\/g, '\\')
                            .trim();
                        
                        try {
                            var highlighted = hljs.highlight(code, {
                                language: language || 'plaintext',
                                ignoreIllegals: true
                            }).value;
                            
                            block.innerHTML = highlighted;
                        } catch (error) {
                            console.error('Error highlighting code block:', error);
                        }
                    });
                    
                    // Handle inline code
                    qaAnswer.querySelectorAll('code:not(.hljs)').forEach(function(inlineCode) {
                        inlineCode.className = 'inline-code';
                    });
                    
                    // Render math formulas
                    MathJax.Hub.Queue(['Typeset', MathJax.Hub, qaAnswer]);
                    
                    // Show answer and buttons
                    qaAnswer.style.display = 'block';
                    qaActions.style.display = 'block';
                    editButtons.style.display = 'block';
                    
                    // Save original content
                    qaAnswer.dataset.originalContent = qaAnswer.innerHTML;
                })
                .catch(function(error) {
                    // Clear timer
                    clearInterval(timerInterval);
                    
                    console.error('Error in askDeepSeek:', error);
                    window.showError('提问失败: ' + error.message);
                    loadingSpinner.style.display = 'none';
                    timerElement.textContent = '思考中...';
                });
            };
            
            // 更新生成进度的函数
            window.updateGenerationProgress = function(data) {
                var container = document.querySelector('.generation-progress');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'generation-progress';
                    document.querySelector('.container').insertBefore(
                        container,
                        document.querySelector('.stats')
                    );
                    
                    // 添加进度条和文本元素
                    container.innerHTML = `
                        <div class="progress-text">正在生成闪卡...</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill"></div>
                        </div>
                        <div class="progress-detail"></div>
                    `;
                }
                
                var progressBar = container.querySelector('.progress-bar-fill');
                var progressText = container.querySelector('.progress-text');
                var progressDetail = container.querySelector('.progress-detail');
                
                // 更新进度
                if (data.total > 0) {
                    var percentage = (data.current / data.total) * 100;
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = '正在生成闪卡... ' + Math.round(percentage) + '%';
                    progressDetail.textContent = '已生成 ' + data.current + ' / ' + data.total + ' 张卡片';
                    
                    // 添加当前步骤的描述
                    if (data.currentStep) {
                        progressDetail.textContent += ' - ' + data.currentStep;
                    }
                }
                
                // 如果生成完成
                if (data.current >= data.total) {
                    setTimeout(function() {
                        container.style.display = 'none';
                    }, 1000);
                }
            };
            
            // 处理服务器发送的事件
            window.handleServerEvent = function(event) {
                var data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'status':
                        // 显示状态消息
                        document.querySelector('.progress-text').textContent = data.data;
                        break;
                        
                    case 'progress':
                        // 更新进度条
                        window.updateGenerationProgress(data.data);
                        break;
                        
                    case 'result':
                        // 处理结果
                        window.flashcards = data.data;
                        window.filename = data.filename;
                        
                        // 隐藏进度显示
                        document.querySelector('.generation-progress').style.display = 'none';
                        
                        // 显示结果
                        if (data.message) {
                            document.querySelector('.progress-text').textContent = data.message;
                        }
                        break;
                        
                    case 'error':
                        // 显示错误消息
                        window.showError(data.data);
                        document.querySelector('.generation-progress').style.display = 'none';
                        break;
                }
            };
            
        })(window, document);
    </script>
</head>
<body>
    <div class="container">
        <div class="error-message"></div>
        <div class="stats">
            <span id="progress-text">0 / 0</span>
        </div>
        <div class="progress-bar">
            <div class="progress" style="width: 0%"></div>
        </div>
        
        <div class="card-container">
            <div class="progress">
                <h3>复习进度</h3>
                <p>当前第 <span id="currentCard">1</span> 张，共 <span id="totalCards">{{ flashcards|length }}</span> 张</p>
                {% if message %}
                    <p>{{ message }}</p>
                {% endif %}
            </div>

            {% for card in flashcards %}
            <div class="card" style="display: {% if loop.index0 == 0 %}block{% else %}none{% endif %};" data-index="{{ loop.index0 }}" data-id="{{ card.id }}">
                <div class="question markdown-body">{{ card.question|safe }}</div>
                <div class="answer markdown-body">{{ card.answer|safe }}</div>
                <div class="buttons">
                    <button class="button show-answer" onclick="showAnswer(this)">显示答案</button>
                    <button class="button difficulty-btn easy" onclick="recordDifficulty('easy', this)">简单</button>
                    <button class="button difficulty-btn medium" onclick="recordDifficulty('medium', this)">一般</button>
                    <button class="button difficulty-btn hard" onclick="recordDifficulty('hard', this)">困难</button>
                </div>
                <div class="qa-section" style="display: none;">
                    <textarea class="qa-input" placeholder="输入你的问题..." rows="3"></textarea>
                    <button class="button btn-ask" onclick="askDeepSeek(this)">向DeepSeek提问</button>
                    <div class="loading-spinner" style="display: none;">
                        <div class="spinner"></div>
                        <span>思考中...</span>
                    </div>
                    <div class="qa-answer" contenteditable="true"></div>
                    <div class="edit-buttons">
                        <button class="button btn-cancel" onclick="cancelEdit(this)">取消</button>
                        <button class="button btn-save" onclick="saveEdit(this)">保存</button>
                    </div>
                    <div class="qa-actions" style="display: none;">
                        <button class="button btn-append" onclick="updateCard('append', this)">补充到当前卡片</button>
                        <button class="button btn-new" onclick="updateCard('new', this)">创建新卡片</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="generation-progress" style="display: none;">
            <div class="progress-text">正在生成闪卡...</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="progress-detail"></div>
        </div>
    </div>
</body>
</html> 